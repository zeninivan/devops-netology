# Домашнее задание к занятию "6.1. Типы и структура СУБД"

## Задача 1
Архитектор ПО решил проконсультироваться у вас, какой тип БД лучше выбрать для хранения определенных данных.

Он вам предоставил следующие типы сущностей, которые нужно будет хранить в БД:

    Электронные чеки в json виде
    Склады и автомобильные дороги для логистической компании
    Генеалогические деревья
    Кэш идентификаторов клиентов с ограниченным временем жизни для движка аутенфикации
    Отношения клиент-покупка для интернет-магазина

Выберите подходящие типы СУБД для каждой сущности и объясните свой выбор.

### Ответ:
1. Электронные чеки в json виде - в данном случае подойдет документоориентированная система управления базами данных. Например, Mongo DB. Она считается одним из классических примеров NoSQL-систем, использующих JSON-подобные документы и схему базы данных. Исходя из обсуждения данного в вопроса в лекции - подойдет идеально для:
 - регистрация и хранение информации о событиях;
 - системы управления документами и контентом;
 - электронная коммерция;  

2. Склады и автомобильные дороги для логистической компании - логическая модель разрабатывается при использовании естественных для человека способов сбора и представления той информации, которую предполагается хранить в создаваемой базе данных логиста предприятия. Сущностями предполагаемой логической модели автоматизации рабочего места логиста являются: продажа, гараж, машина, путевой лист, товар, подкатегория, категория, артикул, водитель. Данные сущности имеют ряд присущих им свойств – атрибутов, а также они имеют связи между собой. Все связи являются неидентифицирующими, то есть они связывают независимые сущности. В результате построения модели предметной области в виде набора сущностей и связей получается связный граф. В итоге, наиболее подходящим типом СУБД для данной сущности я бы выбрал графовые СУБД. NoSQL БД, которые используют структуру графов для семантических запросов. Данные хранятся в виде узлов, ребер и свойств.

3. Генеалогические деревья - для хранения данных этого типа подойдет иерархическая модель. При использовании иерархической модели представления данных, связи между данными можно охарактеризовать с помощью упорядоченного графа (или дерева). 

4. Кэш идентификаторов клиентов с ограниченным временем жизни для движка аутенфикации - СУДБ вида "ключ-значение". Из рассматриваемых в лекции можно отметить Memcached. 
Используется как распределенный кэш, все данные хранятся в оперативной памяти, данным можно присваивать Time-To-Live.

5. Отношения клиент-покупка для интернет-магазина - в данном случае подойдет реляционная модель БД. Основной единицей организации данных в таких БД являются таблицы, соответствующие обычным двумерным таблицам, привычным для пользователя,
например, экономиста. В таблицах БД столбцам соответствуют поля, а строкам - записи. Между таблицами устанавливаются связи (отношения) для возможности получения необходимых данных из двух и более таблиц. 
В БД интернет-магазина могут быть созданы две таблицы: «Заказ» и «Клиент», - связанные между собой. К данным указанных таблиц, использую средства СУБД, могут обращаться все заинтересованные пользователи (финансовый отдел, отдела продаж и т.д.) 

---

## Задача 2
Вы создали распределенное высоконагруженное приложение и хотите классифицировать его согласно CAP-теореме. Какой классификации по CAP-теореме соответствует ваша система, если (каждый пункт - это отдельная реализация вашей системы и для каждого пункта надо привести классификацию):

    Данные записываются на все узлы с задержкой до часа (асинхронная запись)
    При сетевых сбоях, система может разделиться на 2 раздельных кластера
    Система может не прислать корректный ответ или сбросить соединение

А согласно PACELC-теореме, как бы вы классифицировали данные реализации?

### Ответ:
1. CA (по CAP), EL - PC (по PACELC)
2. AP (по CAP), PA - EL (по PACELC)
3. CP (по CAP), PA - EC (по PACELC)

### Доработка к задаче 2:

1. CA (по CAP), EL - PC (по PACELC)

    CA и PC подразумевают консистентность данных. Разве при асинхронной репликации может быть целостность данных в общем случае?

В данном случае точно можно утверждать что по CAP система удовлетворяет требованию P - устойчивость к разделению (Partition tolerance). Для связи используется асинхронная сеть, которая может терять или задерживать сообщения. C (consistency) здесь лишнее. В ощем случае, если разрешить приложению читать с реплик, а реплики асинхронные, тогда зависимая БД может быть устаревшей. В этом случае чтение будет не линеаризованным, т.е. не CAP-согласованным. Также можно считать систему доступной исходя из определения доступности. Запрос к системе завершится корректным откликом, но нет гарантии, что ответ с разных узлов будет одинаковым. Например, система может отвечать в течении часа - если ответ корректный, в рамках CAP теоремы, это доступная система.

Согласно PACELC, в случае сетевого разделения (P) в распределнной системе необходимо выбирать между доступностью (А) и согласованностью (С) и (Е, ELSE) между задержкой (L) и согласованностью (С). 
По PACELC наша система более похожа на PA - EL.

Скорректированный ответ: PA (по CAP) и PA - EL (по PACELC).

2. AP (по CAP), PA - EL (по PACELC)

    Верно, возможны ли и другие варианты?

Возможен еще вариант, когда систему нельзя будет считать доступной. Например, система будет отвечать на запросы несколько часов или запрос данных будет производиться раньше синхронизации узлов. Допустим у нас есть 2 копии базы данных в двух разных датацентрах и произошло сетевое разъединение. Приложение продолжает работать и позволяет запись в базу данных, оно полностью доступно для обоих датацентров. Но так как связь между ДЦ прервана, все изменения в одном ДЦ не будут доступны в другом. В другом ДЦ, данные которого не могут быть в актуальном состоянии из-за потери соединения, база данных должна прекратить обслуживать клиентов на чтение и запись до восстановления синхронизации. В таких случаях система удовлетворяет только P свойству.

3. CP (по CAP), PA - EC (по PACELC)

    СP - верно. По какому принципу выбирали?

В данном случае есть признак того, что система потеряла досутпность. Запрос к распределённой системе не завершается корректным откликом.
CP системы, могут быть недоступны, т.к. буду пытаться придти к согласованному состоянию и не будут нам отвечать.

Может ли первая пара выбранная для PACELC классификации отличаться по смыслу от пары выбранной для CAP классификации (кроме CA)? Откуда у вас взялась A(vailability) в PACELC классификации?

Нет, кроме CA отличий между CAP и PACELC быть не должно. Теорема PACELC основана на CAP и дополняет ее, позволяя взглянуть на систему ещё с одного ракурса.
В первой паре по PACELC я допустил ошибку, вместо PA должно быть свойство PC, т.к. в описанном сценарии система теряет доступность. 
По PACELC - это PC-EC система.   

### Доработка 2 к задаче 2:

````   
Все что мы знаем о системе, — что она устойчива к разделению?
Т.е. система обладает как минимум свойством P, и далее могут быть различные варианты.
По CAP система может быть похожа на P, AP, CP, и еще больше вариантов по PACELC, PA/EL, PA/EC, PC/EL, PC/EC. 
Как думаете, возможно ли такое?
````

В данном сценарии мы понимаем, что система обладает как минимум свойством Р, а далее, согласно CAP-теореме мы можем подобрать второе свойство системы (выбор между С и А), которое не будет противоречить описанному сценарию. 
Разделение сети может привести к самодостаточному функционированию отдельных узлов. Любая неупавшая нода в системе может ответить на запрос.
Такое поведение системы говорит о сохранении ее доступности - А. Т.е. запросы к отдельным кластерам распределённой системы будут завершаться корректным откликом, но, без гарантии, что ответы всех узлов системы совпадут.
При этом у нас нарушается репликация между кластерами системы и мы не можем обеспечить согласованность данных - С.

Т.о., по CAP - это система похожа на AP.

Согласно PACELC, в случае сетевого разделения (P) в распределнной системе необходимо выбирать между доступностью (А) и согласованностью (С), как и в CAP теореме. В остальном (Е, ELSE) даже при наормальной работе 
системы без разделения, нужно выбирать между задержкой (L) и согласованностью (С).
Т.к. мы уже определили, что система по CAP похожа на AP, то остается выбрать между Latency и Consistency. Consistency мы обеспечить не можем, пока не восстановится репликация между кластерами. Время, за которое клиент получит ответ
не ограничено каким-то значением в описанном сценарии, поэтому можем считать, что Latency нам доступно.

Т.о., по PACELC - это система похожа на PA/EL.

### Доработка 3 к задаче 2:
Задача 2.2.

При сетевых сбоях, система может разделиться на 2 раздельных кластера:
````
Любая неупавшая нода в системе может ответить на запрос. Такое поведение системы говорит о сохранении ее доступности - А.

Но это лишь один из возможных вариантов? Ведь в условиях задачи не утверждается, что система сохраняет доступность? Т.е. может быть как AP, там и CP ?
````
Добрый день!
Да, это один из возможных вариантов. В условиях задачи не утверждается о сохранении доступности. Возможен и другой сценарий. 

Кластеры A и B видят, что потеряли связь друг с другом. Они перестают обрабатывать запросы. В этом случае согласованность не нарушится, но будет потеряна A-availability.
Поэтому, если мы допускаем вероятность разделения системы (свойство P), то при возниконовении сплита остается только выбирать - A или C.

Т.о. по CAP система (в данном сценарии) может быть как P или AP, так и CP.

По PACELC - возможны PA/EL, PA/EC, PC/EL, PC/EC.

---

## Задача 3 
Могут ли в одной системе сочетаться принципы BASE и ACID? Почему?

### Ответ:
Сами принципы BASE (высокопроизводительные системы) и ACID (высоконадежные системы) противопоставлены друг другу. В лекции в теореме CAP говорится об условности понятий. Например, система может отвечать в течении часа - если ответ корректный, в рамках CAP теоремы, это доступная система. В рамках сложной системы могут частично сочетаться отдельные принципы из BASE и ACID. Любая БД, как и любая технология и подход вообще – это компромисс, на который придётся пойти в угоду чему-то. Многие БД NoSQL жертвуют согласованностью данных или другими свойствами из ACID ради более высокой производительности, получая которую, вы перекладываете дополнительную ответственность на ваше приложение. Либо вы используете БД, которая предоставляет гарантии ACID, и лишаете себя головной боли, но получаете меньшую производительность.

---

## Задача 4
Вам дали задачу написать системное решение, основой которого бы послужили:

    фиксация некоторых значений с временем жизни
    реакция на истечение таймаута

Вы слышали о key-value хранилище, которое имеет механизм Pub/Sub. Что это за система? Какие минусы выбора данной системы?

### Ответ:
key-value хранилище, которое имеет механизм Pub/Sub - это СУБД Redis. 

Redis можно отнести к NoSQL - семейству БД. Имеет слабые ACID свойства (уклон в сторону BASE для производительности). Синтаксис Redis не схож с SQL. Данные в момент работы хранятся в оперативной памяти, поэтому максимальный ее объем зависит от объема последней. Система репликации Redis сама по себе не поддерживает автоматическую отказоустойчивость: если ведущий узел выходит из строя, необходимо вручную выбрать нового ведущего среди ведомых узлов, либо доукомплектовать систему Redis Sentinel. Т.к. механизм Pub/Sub не поддерживает синхронную сквозную связь, обмен сообщениями Pub/Sub не подходит для мультимедиа (видео-конференции, VOIP, потоковая передача аудио/видео).

---
